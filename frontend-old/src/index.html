<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>VoteHub â€” Cast Your Vote</title>
  <link rel="stylesheet" href="stl.css" />
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    .page-header {
      text-align: center;
      margin-bottom: 3rem;
      position: relative;
    }
    .header-icon {
      width: 80px;
      height: 80px;
      margin: 0 auto 1.5rem;
      background: linear-gradient(135deg, #3b82f6, #7c3aed);
      border-radius: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 10px 35px rgba(59,130,246,0.3);
      animation: pulseGentle 2s ease-in-out infinite;
    }
    .page-title {
      font-size: 2.5rem;
      font-weight: 700;
      background: linear-gradient(90deg, #3b82f6, #7c3aed, #ec4899);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      margin-bottom: 0.75rem;
      animation: gradientFlow 3s ease infinite;
      background-size: 200% 200%;
    }
    .page-subtitle {
      color: #9aa4b2;
      font-size: 1.1rem;
    }
    .voting-card {
      background: var(--card);
      border-radius: 1.25rem;
      padding: 2rem;
      border: 1px solid rgba(255,255,255,0.04);
      box-shadow: 0 10px 30px rgba(2,6,23,0.6);
    }
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid rgba(255,255,255,0.06);
    }
    .section-title {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-size: 1.5rem;
      font-weight: 600;
      color: #eef2f7;
    }
    .action-bar {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
      justify-content: center;
      margin-top: 2rem;
      padding-top: 2rem;
      border-top: 1px solid rgba(255,255,255,0.06);
    }
    .btn-with-icon {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1.25rem;
    }
    .vote-success-message {
      background: linear-gradient(135deg, rgba(16,185,129,0.1), rgba(6,182,212,0.1));
      border: 1px solid rgba(16,185,129,0.3);
      border-radius: 1rem;
      padding: 1.5rem;
      text-align: center;
      margin-bottom: 1.5rem;
      animation: slideUp 0.5s ease;
    }
    .vote-success-message h3 {
      color: #10b981;
      font-size: 1.3rem;
      margin: 0 0 0.5rem 0;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }
    .vote-success-message p {
      color: #9aa4b2;
      margin: 0;
    }
    .enhanced-vote-btn {
      margin-top: 0.75rem;
      width: 100%;
      padding: 0.65rem;
      background: linear-gradient(90deg, #3b82f6, #7c3aed);
      color: white;
      border: none;
      border-radius: 0.75rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }
    .enhanced-vote-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(59,130,246,0.3);
    }
    .enhanced-vote-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
  </style>
</head>
<body class="bg-900">
  <main class="site-main">
    <!-- Page Header -->
    <div class="page-header">
      <div class="header-icon">
        <i data-lucide="vote" style="width: 40px; height: 40px; color: white;"></i>
      </div>
      <h1 class="page-title">Cast Your Vote</h1>
      <p class="page-subtitle">Select your preferred candidate and make your voice heard</p>
    </div>

    <!-- Voting Card -->
    <div class="voting-card max-w-4xl mx-auto">
      <div class="section-header">
        <div class="section-title">
          <i data-lucide="users" style="width: 28px; height: 28px; color: #3b82f6;"></i>
          <span>Available Candidates</span>
        </div>
        <button id="refresh-candidates" class="btn-primary" style="padding: 0.6rem 1rem; font-size: 0.9rem;">
          <i data-lucide="refresh-cw" style="width: 16px; height: 16px;"></i>
          Refresh
        </button>
      </div>

      <div id="vote-success" style="display: none;"></div>
      <div id="candidate-grid" class="candidate-grid"></div>
      <div id="notification"></div>

      <!-- Action Bar -->
      <div class="action-bar">
        <a href="results.html" class="btn-secondary btn-with-icon">
          <i data-lucide="bar-chart-3" style="width: 18px; height: 18px;"></i>
          View Results
        </a>
        <a href="admin-dashboard.html" class="btn-primary btn-with-icon">
          <i data-lucide="layout-dashboard" style="width: 18px; height: 18px;"></i>
          Admin Dashboard
        </a>
        <a href="admin-api.html" class="btn-secondary btn-with-icon">
          <i data-lucide="settings" style="width: 18px; height: 18px;"></i>
          Manage Candidates
        </a>
        <button class="btn-secondary btn-with-icon" id="logoutBtn">
          <i data-lucide="log-out" style="width: 18px; height: 18px;"></i>
          Logout
        </button>
      </div>
    </div>
  </main>
  <script>
    function getItem(key, fallback) {
      try { return JSON.parse(localStorage.getItem(key)) ?? fallback; } catch { return fallback; }
    }
    function setItem(key, val) {
      try { localStorage.setItem(key, JSON.stringify(val)); } catch {}
    }
    function vote(candidateId) {
      const session = getItem('LS_SESSION', null);
      if (!session) return { error: 'Not logged in' };
      const users = getItem('LS_USERS', []);
      const user = users.find(u => u.id === session.userId);
      if (!user) return { error: 'User not found' };
      if (user.hasVoted) return { error: 'Already voted' };
      user.hasVoted = true;
      setItem('LS_USERS', users);
      const votes = getItem('LS_VOTES', []);
      votes.push({ userId: user.id, candidateId, ts: Date.now() });
      setItem('LS_VOTES', votes);
      return { success: true };
    }
    function getCandidates() { return getItem('LS_CANDIDATES', []); }
    function getSession() { return getItem('LS_SESSION', null); }
    function logout() { localStorage.removeItem('LS_SESSION'); window.location = 'login.html'; }
    const candidateGrid = document.getElementById('candidate-grid');
    const notification = document.getElementById('notification');
    const voteSuccess = document.getElementById('vote-success');
    const session = getSession();
    
    // Initialize Lucide icons
    if (typeof lucide !== 'undefined') {
      lucide.createIcons();
    }
    
    if (!session) window.location = 'login.html';
    
    // Check if user has already voted
    function hasUserVoted() {
      const users = getItem('LS_USERS', []);
      const user = users.find(u => u.id === session.userId);
      return user ? user.hasVoted : false;
    }
    
    function renderCandidates() {
      candidateGrid.innerHTML = '';
      const candidates = getCandidates();
      const userVoted = hasUserVoted();
      
      if (userVoted) {
        voteSuccess.style.display = 'block';
        voteSuccess.innerHTML = `
          <div class="vote-success-message">
            <h3>
              <i data-lucide="check-circle" style="width: 28px; height: 28px;"></i>
              Vote Successfully Cast!
            </h3>
            <p>Thank you for participating. Your vote has been recorded securely.</p>
          </div>
        `;
        lucide.createIcons();
      } else {
        voteSuccess.style.display = 'none';
      }
      
      if (candidates.length === 0) {
        candidateGrid.innerHTML = `
          <div style="text-align: center; padding: 3rem; color: #9aa4b2;">
            <i data-lucide="inbox" style="width: 64px; height: 64px; margin: 0 auto 1rem; opacity: 0.5;"></i>
            <p style="font-size: 1.1rem;">No candidates available yet.</p>
            <p style="font-size: 0.9rem;">Please check back later or contact the admin.</p>
          </div>
        `;
        lucide.createIcons();
        return;
      }
      
      candidates.forEach(c => {
        const card = document.createElement('div');
        card.className = 'candidate-card';
        card.innerHTML = `
          <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.75rem;">
            <div class='candidate-avatar'>${c.name[0]}</div>
            <div style="flex: 1;">
              <div class='candidate-name'>${c.name}</div>
              <div class='candidate-party' style="color: #9aa4b2; font-size: 0.9rem;">${c.party || 'Independent'}</div>
            </div>
          </div>
          <button class='enhanced-vote-btn' ${userVoted ? 'disabled' : ''}>
            <i data-lucide="${userVoted ? 'check' : 'check-circle'}" style="width: 18px; height: 18px;"></i>
            ${userVoted ? 'Voted' : 'Vote Now'}
          </button>
        `;
        
        const voteBtn = card.querySelector('.enhanced-vote-btn');
        if (!userVoted) {
          voteBtn.onclick = () => {
            voteBtn.disabled = true;
            voteBtn.innerHTML = '<i data-lucide="loader-2" style="width: 18px; height: 18px; animation: spin 1s linear infinite;"></i> Voting...';
            lucide.createIcons();
            
            setTimeout(() => {
              const result = vote(c.id);
              if (result.error) {
                notification.innerHTML = `
                  <div class="notification error" style="display: flex; align-items: center; gap: 0.75rem; animation: slideIn 0.3s ease;">
                    <i data-lucide="x-circle" style="width: 20px; height: 20px;"></i>
                    <span>${result.error}</span>
                  </div>
                `;
                voteBtn.disabled = false;
                voteBtn.innerHTML = '<i data-lucide="check-circle" style="width: 18px; height: 18px;"></i> Vote Now';
              } else {
                notification.innerHTML = `
                  <div class="notification success" style="display: flex; align-items: center; gap: 0.75rem; animation: slideIn 0.3s ease;">
                    <i data-lucide="check-circle" style="width: 20px; height: 20px;"></i>
                    <span>ðŸŽ‰ Vote recorded successfully!</span>
                  </div>
                `;
                setTimeout(() => {
                  renderCandidates();
                }, 1000);
              }
              lucide.createIcons();
            }, 800);
          };
        }
        
        candidateGrid.appendChild(card);
      });
      
      lucide.createIcons();
    }
    
    renderCandidates();
    document.getElementById('logoutBtn').onclick = logout;
    document.getElementById('refresh-candidates').onclick = () => {
      renderCandidates();
      notification.innerHTML = `
        <div class="notification info" style="display: flex; align-items: center; gap: 0.75rem; animation: slideIn 0.3s ease;">
          <i data-lucide="refresh-cw" style="width: 20px; height: 20px;"></i>
          <span>Candidates list refreshed</span>
        </div>
      `;
      lucide.createIcons();
      setTimeout(() => {
        notification.innerHTML = '';
      }, 2000);
    };
  </script>
  <style>
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
  </style>
</body>
</html>